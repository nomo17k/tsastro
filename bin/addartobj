#!/usr/bin/env python2.6
"""
Add artificially generated object(s) to an input image.
"""
from __future__ import absolute_import
from __future__ import division
from __future__ import print_function
#from __future__ import unicode_literals
from optparse import OptionParser
from tempfile import NamedTemporaryFile
import warnings
import numpy as np
import pyfits as pf
from tsastro.morph2d import Gaussian, GIM2D


__version__ = '20110121'


class InvalidModelError(Exception): pass


def parsemodel(tokens):
    """
    Given tokens of strings (either from input arguments or a file),
    convert them to model instances.
    """
    # model id as in input and class object and number of parameters
    modeltable = {'gauss': (Gaussian, (2,)),
                  'gim2d': (GIM2D, (9, 10)}
    models = []
    idx = 0
    while 1:
        if idx >= len(tokens):
            break
        x, y, t = tokens[idx:idx + 3]
        if t not in modeltable:
            raise InvalidModelError('invalid input model format')
        m, npars = modeltable[t]
        npar = 0
        for np in npars:
            if tokens[idx + 3 + np + 2] in modeltable:
                npar = np
                break
        if np == 0:
            raise InvalidModelError('invalid input model format')

        pars = [float(p) for p in tokens[idx + 3: idx + 3 + npar]]
        models.append((float(x), float(y), m(*pars)))
        idx += npar + 3
    return models


def addartobj(inim, outim, models, save=False, tmpfile=None, modelfile=None,
              imext=0):
    with pf.open(inim, memmap=True) as f:
        im = f[imext].data
        hdr = f[imext].header

    if save or modelfile is not None:
        ids, xs, ys, ms, ps = [], [], [], [], []
    for i, (x, y, model) in enumerate(models):
        im = model.generate(x, y, im)
        if save or modelfile is not None:
            ids.append(i + 1)
            xs.append(x)
            ys.append(y)
            ms.append(model.name)
            ps.append(model.parameters)

    if save or modelfile is not None:
        cs = []
        a = cs.append
        a(pf.Column(name='id', format='J', array=ids))
        a(pf.Column(name='x', format='E', array=xs))
        a(pf.Column(name='y', format='E', array=ys))
        a(pf.Column(name='model', format='16A', array=ms))
        a(pf.Column(name='param', format='PE(16)', array=ps))
        bt = pf.new_table(cs)
        bt.header.update('EXTNAME', 'ARTOBJ CATALOG')

    # add info to header
    hdr.update('AOBJINFO', 'addartobj [v%s] by Taro Sato' % __version__)
    hdr.update('AOBINPUT', inim, comment='input image used')

    hdus = (pf.HDUList([pf.PrimaryHDU(im, hdr), bt]) if save
            else pf.HDUList([pf.PrimaryHDU(im, hdr)]))

    if modelfile is not None:
        with warnings.catch_warnings():
            warnings.simplefilter('ignore')
            bt.writeto(modelfile, clobber=True)

    with warnings.catch_warnings():
        warnings.simplefilter('ignore')
        hdus.writeto(outim, clobber=True)

    # TODO: maybe there is a better way to keep the temporary file
    # alive till this point.
    if tmpfile is not None:
        tmpfile.close()


if __name__ == '__main__':
    usage = ("\n%prog [OPTIONS] INPUT OUTPUT"
             " [X Y MODEL PAR1 PAR2 ... [X Y MODEL PAR1 PAR2 ...]]"
             "\n%prog [OPTIONS] -n XSIZE YSIZE OUTPUT"
             " [X Y MODEL PAR1 PAR2 ... [X Y MODEL PAR1 PAR2 ...]]")
    p = OptionParser(usage=usage, version=__version__,
                     description=__doc__)
    p.add_option('-f', '--file', type='string', default=None,
                 help='read models from a file')
    p.add_option('-n', '--new', type='int', nargs=2, default=None,
                 help='generate a new image of given shape')
    p.add_option('-s', '--save', action='store_true', default=False,
                 help='save models into to a FITS extention')
    p.add_option('--modelfile', default=None,
                 help='save models as a FITS file')

    opts, args = p.parse_args()

    if opts.new is None:
        nargs = 2
        tmpfile = None
        inim = args[0]
    else:
        nargs = 1
        # generate a new fits image
        xsize, ysize = opts.new
        data = np.zeros((ysize, xsize), dtype='f')
        tmpfile = NamedTemporaryFile()
        pf.PrimaryHDU(data).writeto(tmpfile.name)
        inim = tmpfile.name

    if opts.file is None:
        if len(args) <= nargs:
            p.error('invalid arguments')
        models = args[nargs:]
    else:
        models = [] 
        with open(opts.file) as f:
            for line in f:
                if line.startswith('#'):
                    continue
                models.extend(line.strip().split())
    models = parsemodel(models)

    outim = args[nargs - 1]

    addartobj(inim, outim, models, save=opts.save, tmpfile=tmpfile,
              modelfile=opts.modelfile)
